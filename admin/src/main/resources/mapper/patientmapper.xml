<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.sm.app.repository.PatientRepository">

    <!-- Result Map -->
    <resultMap id="patientResultMap" type="edu.sm.app.dto.Patient">
        <id property="patientId" column="patient_id"/>
        <result property="patientPwd" column="password"/>
        <result property="patientName" column="name"/>
        <result property="patientPhone" column="phone"/>
        <result property="patientEmail" column="email"/>
        <result property="patientDob" column="dob"/>
        <result property="patientGender" column="gender"/>
        <result property="patientAddr" column="address"/>
        <result property="patientMedicalHistory" column="medical_history"/>
        <result property="patientLifestyleHabits" column="lifestyle_habits"/>
        <result property="patientAccountStatus" column="account_status"/>
        <result property="languagePreference" column="language_preference"/>
        <result property="patientRegdate" column="created_at"/>
        <result property="patientUpdate" column="updated_at"/>
        <result property="provider" column="provider"/>
        <result property="providerId" column="provider_id"/>
        <result property="userRole" column="user_role"/>
    </resultMap>

    <!-- 기본 CRUD -->
    <insert id="insert" parameterType="Patient" useGeneratedKeys="true" keyProperty="patientId">
        INSERT INTO patient (
            password, name, phone, email, dob, gender, address,
            medical_history, lifestyle_habits, account_status,
            language_preference, provider, provider_id, user_role, created_at
        ) VALUES (
                     #{patientPwd}, #{patientName}, #{patientPhone}, #{patientEmail},
                     #{patientDob}, #{patientGender}, #{patientAddr},
                     #{patientMedicalHistory}, #{patientLifestyleHabits},
                     #{patientAccountStatus}, #{languagePreference},
                     #{provider}, #{providerId}, #{userRole}, NOW()
                 )
    </insert>

    <update id="update" parameterType="Patient">
        UPDATE patient SET
                           password = #{patientPwd},
                           name = #{patientName},
                           phone = #{patientPhone},
                           email = #{patientEmail},
                           dob = #{patientDob},
                           gender = #{patientGender},
                           address = #{patientAddr},
                           medical_history = #{patientMedicalHistory},
                           lifestyle_habits = #{patientLifestyleHabits},
                           account_status = #{patientAccountStatus},
                           language_preference = #{languagePreference},
                           updated_at = NOW()
        WHERE patient_id = #{patientId}
    </update>

    <delete id="delete" parameterType="Long">
        DELETE FROM patient WHERE patient_id = #{patientId}
    </delete>

    <select id="select" parameterType="Long" resultMap="patientResultMap">
        SELECT * FROM patient WHERE patient_id = #{patientId}
    </select>

    <select id="selectAll" resultMap="patientResultMap">
        SELECT * FROM patient ORDER BY created_at DESC
    </select>

    <!-- 관리자 기능: 환자 목록 조회 (페이징) -->
    <select id="selectAllPatients" resultMap="patientResultMap">
        SELECT * FROM patient
        ORDER BY created_at DESC
    </select>

    <!-- 관리자 기능: 계정 상태별 환자 조회 -->
    <select id="selectByAccountStatus" parameterType="String" resultMap="patientResultMap">
        SELECT * FROM patient
        WHERE account_status = #{status}
        ORDER BY created_at DESC
    </select>

    <!-- 관리자 기능: 계정 상태 변경 -->
    <update id="updateAccountStatus">
        UPDATE patient SET
                           account_status = #{status},
                           updated_at = NOW()
        WHERE patient_id = #{patientId}
    </update>

    <!-- 관리자 기능: 환자 검색 (이름, 이메일, 전화번호) -->
    <select id="searchPatients" parameterType="String" resultMap="patientResultMap">
        SELECT * FROM patient
        WHERE name LIKE CONCAT('%', #{keyword}, '%')
           OR email LIKE CONCAT('%', #{keyword}, '%')
           OR phone LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY created_at DESC
    </select>

    <!-- 관리자 기능: 환자 상세 정보 조회 -->
    <select id="selectPatientDetail" parameterType="Long" resultMap="patientResultMap">
        SELECT * FROM patient WHERE patient_id = #{patientId}
    </select>

    <!-- 관리자 기능: 복합 조건 검색 -->
    <select id="searchPatientsAdvanced" resultMap="patientResultMap">
        SELECT * FROM patient
        <where>
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%')
                OR email LIKE CONCAT('%', #{keyword}, '%')
                OR phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="status != null and status != ''">
                AND account_status = #{status}
            </if>
            <if test="gender != null and gender != ''">
                AND gender = #{gender}
            </if>
            <if test="startDate != null">
                AND created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND created_at &lt;= #{endDate}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- OAuth 관련 -->
    <select id="findByPatientEmail" parameterType="String" resultMap="patientResultMap">
        SELECT * FROM patient WHERE email = #{email}
    </select>

    <select id="findByProviderAndProviderId" resultMap="patientResultMap">
        SELECT * FROM patient
        WHERE provider = #{provider} AND provider_id = #{providerId}
    </select>

    <delete id="deleteByEmail" parameterType="String">
        DELETE FROM patient WHERE email = #{email}
    </delete>

    <select id="findByPatientId" parameterType="Long" resultMap="patientResultMap">
        SELECT * FROM patient WHERE patient_id = #{patientId}
    </select>

    <!-- 관리자 기능: 통계 정보 -->
    <select id="countByAccountStatus" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM patient WHERE account_status = #{status}
    </select>

    <select id="countTotalPatients" resultType="int">
        SELECT COUNT(*) FROM patient
    </select>

</mapper>