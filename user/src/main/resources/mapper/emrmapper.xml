<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.sm.app.repository.EmrRepository">

  <select id="findTopByPatientIdOrderByCreatedAtDesc" parameterType="long" resultType="Emr">
    SELECT e.*
    FROM emr e
    WHERE e.patient_id = #{patientId}
    ORDER BY e.created_at DESC
    LIMIT 1
  </select>

  <select id="findByPatientId" parameterType="long" resultType="Emr">
    SELECT e.*
    FROM emr e
    WHERE e.patient_id = #{patientId}
    ORDER BY e.created_at DESC
  </select>

  <select id="selectAll" resultType="Emr">
    SELECT * FROM emr ORDER BY created_at DESC
  </select>

  <select id="select" parameterType="long" resultType="Emr">
    SELECT * FROM emr WHERE emr_id = #{emrId}
  </select>

  <insert id="insert" parameterType="Emr" useGeneratedKeys="true" keyProperty="emrId">
    INSERT INTO emr (consultation_id, patient_statement, test_results,
                     prescription_details, ai_generated_draft, final_record, created_at)
    VALUES (#{consultationId}, #{patientStatement}, #{testResults},
            #{prescriptionDetails}, #{aiGeneratedDraft}, #{finalRecord}, NOW())
  </insert>

  <update id="update" parameterType="Emr">
    UPDATE emr SET final_record = #{finalRecord}, updated_at = NOW()
    WHERE emr_id = #{emrId}
  </update>

  <delete id="delete" parameterType="long">
    DELETE FROM emr WHERE emr_id = #{emrId}
  </delete>

</mapper>
