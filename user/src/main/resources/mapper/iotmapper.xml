<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.sm.app.repository.IotRepository">

  <!-- ê¸°ê°„ë³„ ì¡°íšŒ (AI ë¶„ì„ìš©) -->
  <select id="findByPatientIdAndMeasuredAtAfterOrderByMeasuredAtDesc" resultType="Iot">
    SELECT * FROM IOT
    WHERE patient_id = #{patientId} AND measured_at >= #{measuredAt}
    ORDER BY measured_at DESC
  </select>

  <!-- í™˜ìžë³„ ì „ì²´ ì¡°íšŒ -->
  <select id="findByPatientId" parameterType="long" resultType="Iot">
    SELECT * FROM IOT
    WHERE patient_id = #{patientId}
    ORDER BY measured_at DESC
  </select>

  <!-- ë¹„ì •ìƒ ë°ì´í„°ë§Œ ì¡°íšŒ -->
  <select id="findByPatientIdAndIsAbnormal" resultType="Iot">
    SELECT * FROM IOT
    WHERE patient_id = #{patientId} AND is_abnormal = #{isAbnormal}
    ORDER BY measured_at DESC
  </select>

  <!-- íŠ¹ì • ë°”ì´íƒˆ íƒ€ìž… ì¡°íšŒ -->
  <select id="findByPatientIdAndVitalType" resultType="Iot">
    SELECT * FROM IOT
    WHERE patient_id = #{patientId} AND vital_type = #{vitalType}
    ORDER BY measured_at DESC
  </select>

  <!-- ðŸ†• ìµœê·¼ Nê°œ ë°ì´í„° ì¡°íšŒ (AI ë§¥ë½ ì œê³µìš©) -->
  <select id="findRecentByPatientId" resultType="Iot">
    SELECT * FROM IOT
    WHERE patient_id = #{patientId}
    ORDER BY measured_at DESC
    LIMIT #{limit}
  </select>

  <!-- ðŸ†• íŠ¹ì • ë°”ì´íƒˆì˜ ìµœê·¼ Nê°œ ì¡°íšŒ (ì¶”ì„¸ ë¶„ì„ìš©) -->
  <select id="findRecentByPatientIdAndVitalType" resultType="Iot">
    SELECT * FROM IOT
    WHERE patient_id = #{patientId} AND vital_type = #{vitalType}
    ORDER BY measured_at DESC
    LIMIT #{limit}
  </select>

  <!-- ì „ì²´ ì¡°íšŒ -->
  <select id="selectAll" resultType="Iot">
    SELECT * FROM IOT ORDER BY measured_at DESC
  </select>

  <!-- ë‹¨ê±´ ì¡°íšŒ (data_id ì‚¬ìš©) -->
  <select id="select" parameterType="long" resultType="Iot">
    SELECT * FROM IOT WHERE data_id = #{dataId}
  </select>

  <!-- ë°ì´í„° ì‚½ìž… (data_id ìžë™ ìƒì„±) -->
  <insert id="insert" parameterType="Iot" useGeneratedKeys="true" keyProperty="dataId">
    INSERT INTO IOT (patient_id, device_type, vital_type, value, is_abnormal, measured_at)
    VALUES (#{patientId}, #{deviceType}, #{vitalType}, #{value}, #{isAbnormal}, NOW())
  </insert>

  <!-- ìˆ˜ì • (data_id ì‚¬ìš©) -->
  <update id="update" parameterType="Iot">
    UPDATE IOT
    SET is_abnormal = #{isAbnormal}
    WHERE data_id = #{dataId}
  </update>

  <!-- ì‚­ì œ (data_id ì‚¬ìš©) -->
  <delete id="delete" parameterType="long">
    DELETE FROM IOT WHERE data_id = #{dataId}
  </delete>

</mapper>
